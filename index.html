<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget Tracker – Email/Password + REQUIRED MFA (TOTP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    h2 { margin-top: 1.5rem; }
    form { display: grid; gap: 8px; max-width: 460px; }
    input, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 10px; align-items: center; margin: 6px 0; flex-wrap: wrap; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px; margin: 10px 0; }
    .hide { display: none; }
    .ok { color:#0a7; } .err { color:#c00; }
    pre { background:#f6f6f6; padding:10px; border-radius:8px; overflow:auto; }
    .secret { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 14px; background:#fff; padding:6px 8px; border:1px dashed #bbb; border-radius:8px; display:inline-block; }
    img.qr { width: 220px; height: 220px; border: 1px solid #ddd; border-radius: 8px; }
    .gate { opacity: .45; pointer-events: none; filter: grayscale(0.2); }
  </style>
</head>
<body>
  <h1>Budget Tracker – Email/Password + REQUIRED MFA (TOTP)</h1>

  <p id="status" class="err">Not signed in.</p>
  <div class="row">
    <button id="signout" class="hide">Sign out</button>
  </div>

  <!-- Auth: Sign up / Sign in -->
  <div class="card" id="signup-card">
    <h2>Create account</h2>
    <form id="signup-form">
      <label>Email <input id="su-email" type="email" required placeholder="you@example.com" /></label>
      <label>Password <input id="su-password" type="password" required minlength="6" placeholder="At least 6 characters" /></label>
      <button id="signup-btn" type="submit">Sign up</button>
      <div id="signup-msg"></div>
    </form>
  </div>

  <div class="card" id="signin-card">
    <h2>Sign in</h2>
    <form id="signin-form">
      <label>Email <input id="si-email" type="email" required placeholder="you@example.com" /></label>
      <label>Password <input id="si-password" type="password" required placeholder="Your password" /></label>
      <button id="signin-btn" type="submit">Sign in</button>
      <div id="signin-msg"></div>
    </form>
    <button id="forgot-btn">Forgot password?</button>
  </div>

  <!-- Password reset -->
  <div class="card hide" id="forgot-card">
    <h2>Reset password</h2>
    <form id="forgot-form">
      <label>Email <input id="fp-email" type="email" required placeholder="you@example.com" /></label>
      <button id="forgot-send" type="submit">Send reset email</button>
      <div id="forgot-msg"></div>
    </form>
  </div>

  <div class="card hide" id="recovery-card">
    <h2>Set a new password</h2>
    <form id="recovery-form">
      <label>New password <input id="rp-password" type="password" required minlength="6" /></label>
      <button id="recovery-save" type="submit">Save new password</button>
      <div id="recovery-msg"></div>
    </form>
  </div>

  <!-- ===== REQUIRED MFA (TOTP) SECTION ===== -->
  <div class="card hide" id="mfa-card">
    <h2>MFA Required – Set up TOTP</h2>
    <p id="mfa-status" class="err">MFA not enabled. You must complete setup to continue.</p>

    <div id="mfa-enroll-block">
      <h3>Enable MFA (TOTP)</h3>
      <button id="mfa-start" type="button">Generate QR / Setup key</button>

      <div id="mfa-enroll-ui" class="hide">
        <div class="row">
          <img id="mfa-qr" class="qr" alt="TOTP QR" />
          <div>
            <div>Setup key (Base32): <span id="mfa-secret" class="secret"></span></div>
            <div class="row"><a id="mfa-otpauth" href="#" rel="noopener">Add on this phone</a></div>
          </div>
        </div>
        <div class="row">
          <label>6-digit code <input id="mfa-code" type="text" inputmode="numeric" pattern="\\d{6}" placeholder="123456" /></label>
          <button id="mfa-verify" type="button">Verify & Activate</button>
        </div>
        <div id="mfa-enroll-msg"></div>
      </div>
    </div>

    <div id="mfa-already-block" class="hide">
      <h3 class="ok">MFA is enabled</h3>
      <div id="mfa-factors"></div>
      <p class="ok">You can now use the app normally.</p>
    </div>
  </div>

  <!-- MFA during sign-in (when already enrolled) -->
  <div class="card hide" id="mfa-login-card">
    <h2>Verify MFA Code</h2>
    <p>Enter the 6-digit code from your authenticator app.</p>
    <div class="row">
      <input id="mfa-login-code" type="text" inputmode="numeric" pattern="\\d{6}" placeholder="123456" />
      <button id="mfa-login-verify" type="button">Verify</button>
    </div>
    <div id="mfa-login-msg"></div>
  </div>

  <!-- GATED APP CONTENT -->
  <div id="app-gated" class="gate">
    <div class="card">
      <h2>Paychecks</h2>
      <div class="row">
        <button id="read" type="button">Load latest</button>
      </div>
      <pre id="out"></pre>
    </div>
  </div>

  <div class="card">
    <h2>Debug</h2>
    <pre id="log"></pre>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // ===== Elements
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    const signupCard = document.getElementById('signup-card');
    const signinCard = document.getElementById('signin-card');
    const signoutBtn = document.getElementById('signout');

    const signupForm = document.getElementById('signup-form');
    const signupMsg = document.getElementById('signup-msg');
    const signinForm = document.getElementById('signin-form');
    const signinMsg = document.getElementById('signin-msg');

    const forgotBtn = document.getElementById('forgot-btn');
    const forgotCard = document.getElementById('forgot-card');
    const forgotForm = document.getElementById('forgot-form');
    const forgotMsg = document.getElementById('forgot-msg');

    const recoveryCard = document.getElementById('recovery-card');
    const recoveryForm = document.getElementById('recovery-form');
    const recoveryMsg = document.getElementById('recovery-msg');

    // MFA UI
    const mfaCard = document.getElementById('mfa-card');
    const mfaStatus = document.getElementById('mfa-status');
    const mfaEnrollBlock = document.getElementById('mfa-enroll-block');
    const mfaStartBtn = document.getElementById('mfa-start');
    const mfaEnrollUI = document.getElementById('mfa-enroll-ui');
    const mfaQR = document.getElementById('mfa-qr');
    const mfaSecret = document.getElementById('mfa-secret');
    const mfaOtpAuth = document.getElementById('mfa-otpauth');
    const mfaCode = document.getElementById('mfa-code');
    const mfaVerifyBtn = document.getElementById('mfa-verify');
    const mfaEnrollMsg = document.getElementById('mfa-enroll-msg');
    const mfaAlreadyBlock = document.getElementById('mfa-already-block');
    const mfaFactorsDiv = document.getElementById('mfa-factors');

    const mfaLoginCard = document.getElementById('mfa-login-card');
    const mfaLoginCode = document.getElementById('mfa-login-code');
    const mfaLoginVerifyBtn = document.getElementById('mfa-login-verify');
    const mfaLoginMsg = document.getElementById('mfa-login-msg');

    // App
    const appGated = document.getElementById('app-gated');
    const readBtn = document.getElementById('read');
    const outEl = document.getElementById('out');

    // ===== State
    const REQUIRE_MFA = true;
    let pendingMfa = { factorId: null, challengeId: null };
    let enrollFactorId = null;

    // ===== Helpers
    const log = (label, val) => {
      const msg = `${label}: ${typeof val === 'string' ? val : JSON.stringify(val, null, 2)}`;
      logEl.textContent += msg + "\\n\\n";
      console.log(label, val);
    };
    const gateApp = (blocked) => {
      if (blocked) appGated.classList.add('gate');
      else appGated.classList.remove('gate');
    };
    const setSignedIn = (email) => {
      statusEl.textContent = `Signed in as: ${email}`;
      statusEl.classList.remove('err'); statusEl.classList.add('ok');
      signoutBtn.classList.remove('hide');
      signupCard.classList.add('hide');
      signinCard.classList.add('hide');
      mfaCard.classList.remove('hide');
    };
    const setSignedOut = () => {
      statusEl.textContent = 'Not signed in.';
      statusEl.classList.remove('ok'); statusEl.classList.add('err');
      signoutBtn.classList.add('hide');
      signupCard.classList.remove('hide');
      signinCard.classList.remove('hide');
      mfaCard.classList.add('hide');
      mfaLoginCard.classList.add('hide');
      gateApp(true);
    };

    // ===== Redirect handling (email confirm / recovery)
    async function handleRedirect() {
      const href = location.href;
      log('URL on load', href);
      if (href.includes('code=') || href.includes('access_token=')) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(href);
        if (error) log('exchangeCodeForSession error', error.message);
        else log('exchangeCodeForSession data', data);
        history.replaceState({}, document.title, '/budget-tracker/');
      }
    }
    await handleRedirect();

    // ===== Session reflection
    async function refreshSession() {
      const { data: { session }, error } = await supabase.auth.getSession();
      log('getSession error', error ?? 'none');
      log('getSession session', session ?? null);
      if (session?.user?.email) {
        setSignedIn(session.user.email);
        await enforceMfa();
      } else {
        setSignedOut();
      }
    }
    await refreshSession();

    supabase.auth.onAuthStateChange(async (event, session) => {
      log('onAuthStateChange', { event, user: session?.user ?? null });
      if (session?.user?.email) {
        setSignedIn(session.user.email);
        await enforceMfa();
      } else {
        setSignedOut();
      }
      if (event === 'PASSWORD_RECOVERY') {
        signinCard.classList.add('hide');
        signupCard.classList.add('hide');
        forgotCard.classList.add('hide');
        recoveryCard.classList.remove('hide');
      }
    });

    // ===== Enforce MFA (hard requirement)
    async function enforceMfa() {
      const { data, error } = await supabase.auth.mfa.listFactors();
      log('listFactors', error ?? data);

      const totp = (data?.totp ?? []).filter(f => f.status === 'verified');
      if (totp.length > 0) {
        mfaStatus.textContent = `MFA enabled (${totp.length} TOTP factor${totp.length > 1 ? 's' : ''})`;
        mfaEnrollBlock.classList.add('hide');
        mfaAlreadyBlock.classList.remove('hide');
        mfaFactorsDiv.textContent = totp.map(f => `• TOTP (id: ${f.id})`).join('\\n') || 'TOTP enrolled.';
        gateApp(false); // UNLOCK APP
      } else {
        // No verified factor → lock app and push user through enrollment
        gateApp(true);
        mfaAlreadyBlock.classList.add('hide');
        mfaEnrollBlock.classList.remove('hide');
        mfaStatus.textContent = 'MFA not enabled. You must complete setup to continue.';
        mfaStatus.classList.add('err');
        mfaCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        if (REQUIRE_MFA && mfaEnrollUI.classList.contains('hide')) {
          await startEnroll(); // auto-generate QR + secret
        }
      }
    }

    // ===== Start TOTP enroll
    async function startEnroll() {
      mfaEnrollMsg.textContent = 'Generating…';
      const { data, error } = await supabase.auth.mfa.enroll({ factorType: 'totp' });
      if (error) { mfaEnrollMsg.textContent = 'Enroll error: ' + error.message; return; }
      log('mfa.enroll', data);

      enrollFactorId = data.id;
      mfaQR.src = data.totp.qr_code;           // PNG data URL
      mfaSecret.textContent = data.totp.secret; // Base32
      const user = (await supabase.auth.getUser()).data?.user;
      const issuer = encodeURIComponent('Budget Tracker');
      const account = encodeURIComponent(user?.email || 'user');
      const otpauth = data.totp.uri || `otpauth://totp/${issuer}:${account}?secret=${data.totp.secret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
      mfaOtpAuth.href = otpauth;

      mfaEnrollUI.classList.remove('hide');
      mfaEnrollMsg.textContent = 'Scan QR or tap link / enter setup key, then enter the 6-digit code.';
    }
    document.getElementById('mfa-start').addEventListener('click', startEnroll);

    // ===== Verify and activate factor
    mfaVerifyBtn.addEventListener('click', async () => {
      mfaEnrollMsg.textContent = 'Verifying…';
      const code = mfaCode.value.trim();
      if (!enrollFactorId) { mfaEnrollMsg.textContent = 'No enrollment in progress.'; return; }

      const ch = await supabase.auth.mfa.challenge({ factorId: enrollFactorId });
      if (ch.error) { mfaEnrollMsg.textContent = 'Challenge error: ' + ch.error.message; return; }

      const vr = await supabase.auth.mfa.verify({
        factorId: enrollFactorId,
        code,
        challengeId: ch.data.id,
      });
      if (vr.error) {
        mfaEnrollMsg.textContent = 'Verify error: ' + vr.error.message;
      } else {
        mfaEnrollMsg.textContent = 'MFA enabled!';
        mfaEnrollUI.classList.add('hide');
        mfaCode.value = '';
        enrollFactorId = null;
        await enforceMfa(); // re-check and unlock app
      }
    });

    // ===== Sign up
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupMsg.textContent = '...';
      const email = document.getElementById('su-email').value.trim();
      const password = document.getElementById('su-password').value;

      const { data, error } = await supabase.auth.signUp({
        email, password,
        options: { emailRedirectTo: 'https://charles85298.github.io/budget-tracker/' }
      });
      if (error) signupMsg.textContent = 'Error: ' + error.message;
      else {
        signupMsg.textContent = data?.user?.email_confirmed_at
          ? 'Account created.'
          : 'Check your email to confirm your account.';
        log('signUp', data);
        await refreshSession();
      }
    });

    // ===== Sign in (handles MFA-required case)
    signinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signinMsg.textContent = '...';
      const email = document.getElementById('si-email').value.trim();
      const password = document.getElementById('si-password').value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        const msg = (error.message || '').toLowerCase();
        if (msg.includes('mfa')) {
          signinMsg.textContent = 'MFA required: enter your 6-digit code.';
          const lf = await supabase.auth.mfa.listFactors();
          log('listFactors (after mfa_required)', lf);
          const firstVerified = (lf?.data?.totp ?? []).find(f => f.status === 'verified');
          if (!firstVerified) { signinMsg.textContent = 'MFA required but no verified TOTP factor found.'; return; }
          const ch = await supabase.auth.mfa.challenge({ factorId: firstVerified.id });
          if (ch.error) { signinMsg.textContent = 'Error starting MFA challenge: ' + ch.error.message; return; }
          pendingMfa = { factorId: firstVerified.id, challengeId: ch.data.id };
          mfaLoginCard.classList.remove('hide');
        } else {
          signinMsg.textContent = 'Error: ' + error.message;
        }
      } else {
        signinMsg.textContent = 'Signed in.';
        log('signInWithPassword', data);
        await refreshSession();
      }
    });

    // ===== Verify MFA during login
    mfaLoginVerifyBtn.addEventListener('click', async () => {
      mfaLoginMsg.textContent = 'Verifying…';
      const code = mfaLoginCode.value.trim();
      if (!pendingMfa.factorId || !pendingMfa.challengeId) {
        mfaLoginMsg.textContent = 'No MFA challenge in progress.';
        return;
      }
      const vr = await supabase.auth.mfa.verify({
        factorId: pendingMfa.factorId,
        code,
        challengeId: pendingMfa.challengeId,
      });
      if (vr.error) {
        mfaLoginMsg.textContent = 'MFA verify error: ' + vr.error.message;
      } else {
        mfaLoginMsg.textContent = 'MFA verified. Signed in.';
        mfaLoginCard.classList.add('hide');
        await refreshSession();
      }
    });

    // ===== Password reset
    forgotBtn.addEventListener('click', () => forgotCard.classList.toggle('hide'));
    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      forgotMsg.textContent = '...';
      const email = document.getElementById('fp-email').value.trim();
      const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: 'https://charles85298.github.io/budget-tracker/'
      });
      if (error) forgotMsg.textContent = 'Error: ' + error.message;
      else { forgotMsg.textContent = 'Reset email sent. Check your inbox.'; log('resetPasswordForEmail', data); }
    });
    recoveryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      recoveryMsg.textContent = '...';
      const newPassword = document.getElementById('rp-password').value;
      const { data, error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) recoveryMsg.textContent = 'Error: ' + error.message;
      else { recoveryMsg.textContent = 'Password updated. You are signed in.'; log('updateUser (password)', data); await refreshSession(); }
    });

    // ===== Sign out
    signoutBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) log('signOut error', error.message);
      setSignedOut();
    });

    // ===== Paychecks viewer (inside gated area)
    readBtn?.addEventListener('click', async () => {
      outEl.textContent = 'Loading…';
      const { data, error } = await supabase
        .from('paychecks')
        .select('paycheck_id, employer, pay_date, net_amount')
        .order('pay_date', { ascending: false })
        .limit(50);
      outEl.textContent = error ? `Error: ${error.message}` : JSON.stringify(data, null, 2);
      log('read paychecks', error ?? data);
    });
  </script>
</body>
</html>
