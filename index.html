<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Login Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      font-family: system-ui, Arial; 
      max-width: 600px; 
      margin: 2rem auto; 
      padding: 1rem; 
    }
    .status {
      font-size: 1.2em;
      font-weight: bold;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    .logged-in { 
      background: #d4edda; 
      color: #155724; 
      border: 1px solid #c3e6cb;
    }
    .logged-out { 
      background: #f8d7da; 
      color: #721c24; 
      border: 1px solid #f5c6cb;
    }
    .card { 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      padding: 1rem; 
      margin: 1rem 0; 
    }
    .form-group { 
      margin: 0.5rem 0; 
    }
    label { 
      display: block; 
      margin-bottom: 0.25rem; 
    }
    input { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
    }
    button { 
      background: #007bff; 
      color: white; 
      border: none; 
      padding: 0.75rem 1rem; 
      border-radius: 4px; 
      cursor: pointer; 
      margin: 0.5rem 0; 
    }
    button:hover { 
      background: #0056b3; 
    }
    .hide { 
      display: none; 
    }
    .message { 
      padding: 0.5rem; 
      margin: 0.5rem 0; 
      border-radius: 4px; 
    }
    .success { 
      background: #d4edda; 
      color: #155724; 
    }
    .error { 
      background: #f8d7da; 
      color: #721c24; 
    }
  </style>
</head>
<body>
  <h1>Simple Login Test</h1>

  <!-- Login Status Display -->
  <div id="status" class="status logged-out">
    Not signed in
  </div>

  <!-- Sign Up Form -->
  <div class="card" id="signup-section">
    <h2>Create Account</h2>
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="signup-email" placeholder="you@example.com" />
    </div>
    <div class="form-group">
      <label>Password:</label>
      <input type="password" id="signup-password" placeholder="Password" />
    </div>
    <button onclick="signUp()">Sign Up</button>
    <div id="signup-message" class="message hide"></div>
  </div>

  <!-- Sign In Form -->
  <div class="card" id="signin-section">
    <h2>Sign In</h2>
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="signin-email" placeholder="you@example.com" />
    </div>
    <div class="form-group">
      <label>Password:</label>
      <input type="password" id="signin-password" placeholder="Password" />
    </div>
    <button onclick="signIn()">Sign In</button>
    <button onclick="togglePasswordReset()" style="background: #6c757d;">Forgot Password?</button>
    <div id="signin-message" class="message hide"></div>
  </div>

  <!-- Password Reset Form (hidden by default) -->
  <div class="card hide" id="reset-section">
    <h2>Reset Password</h2>
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="reset-email" placeholder="you@example.com" />
    </div>
    <button onclick="resetPassword()">Send Reset Email</button>
    <button onclick="togglePasswordReset()" style="background: #6c757d;">Back to Sign In</button>
    <div id="reset-message" class="message hide"></div>
  </div>

  <!-- Force New Password Form (shown after password recovery) -->
  <div class="card hide" id="new-password-section">
    <h2>Set New Password</h2>
    <p>You accessed your account via password reset. Please set a new password to continue.</p>
    <div class="form-group">
      <label>New Password:</label>
      <input type="password" id="new-password" placeholder="Enter new password" />
    </div>
    <button onclick="updatePassword()">Set New Password</button>
    <div id="new-password-message" class="message hide"></div>
  </div>

  <!-- MFA Challenge for Password Change -->
  <div class="card hide" id="mfa-challenge-section">
    <h2>MFA Required</h2>
    <p>Enter your 6-digit authenticator code to confirm password change.</p>
    <div class="form-group">
      <label>Authenticator Code:</label>
      <input type="text" id="mfa-challenge-code" placeholder="123456" maxlength="6" />
    </div>
    <button onclick="verifyMFAAndUpdatePassword()">Verify & Update Password</button>
    <div id="mfa-challenge-message" class="message hide"></div>
  </div>

  <!-- Sign Out Button (hidden when logged out) -->
  <div class="card hide" id="signout-section">
    <button onclick="signOut()">Sign Out</button>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // Make functions available globally
    window.supabase = supabase;
    window.signUp = signUp;
    window.signIn = signIn;
    window.signOut = signOut;
    window.resetPassword = resetPassword;
    window.togglePasswordReset = togglePasswordReset;
    window.updatePassword = updatePassword;
    window.verifyMFAAndUpdatePassword = verifyMFAAndUpdatePassword;

    // Store for MFA challenge
    let currentChallengeId = null;
    let currentFactorId = null;
    let pendingPassword = null;

    // Update UI based on login status
    function updateStatus(user, isPasswordRecovery = false) {
      const statusEl = document.getElementById('status');
      const signupSection = document.getElementById('signup-section');
      const signinSection = document.getElementById('signin-section');
      const signoutSection = document.getElementById('signout-section');
      const resetSection = document.getElementById('reset-section');
      const newPasswordSection = document.getElementById('new-password-section');

      // Check if this is the change password page
      const urlParams = new URLSearchParams(window.location.search);
      const isChangePasswordPage = urlParams.get('page') === 'change-password';

      if (isChangePasswordPage && user) {
        // Show only password change form (Supabase docs approach)
        statusEl.textContent = 'Set your new password';
        statusEl.className = 'status logged-out';
        signupSection.classList.add('hide');
        signinSection.classList.add('hide');
        signoutSection.classList.add('hide');
        resetSection.classList.add('hide');
        newPasswordSection.classList.remove('hide');
      } else if (isPasswordRecovery) {
        // Force password change after recovery (fallback)
        statusEl.textContent = 'Password reset required - set new password';
        statusEl.className = 'status logged-out';
        signupSection.classList.add('hide');
        signinSection.classList.add('hide');
        signoutSection.classList.add('hide');
        resetSection.classList.add('hide');
        newPasswordSection.classList.remove('hide');
      } else if (user) {
        statusEl.textContent = `Logged in as: ${user.email}`;
        statusEl.className = 'status logged-in';
        signupSection.classList.add('hide');
        signinSection.classList.add('hide');
        signoutSection.classList.remove('hide');
        resetSection.classList.add('hide');
        newPasswordSection.classList.add('hide');
      } else {
        statusEl.textContent = 'Not signed in';
        statusEl.className = 'status logged-out';
        signupSection.classList.remove('hide');
        signinSection.classList.remove('hide');
        signoutSection.classList.add('hide');
        resetSection.classList.add('hide');
        newPasswordSection.classList.add('hide');
      }
    }

    // Show message
    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message ${isError ? 'error' : 'success'}`;
      el.classList.remove('hide');
    }

    // Hide message
    function hideMessage(elementId) {
      document.getElementById(elementId).classList.add('hide');
    }

    // Sign up function
    async function signUp() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      hideMessage('signup-message');

      if (!email || !password) {
        showMessage('signup-message', 'Please fill in all fields', true);
        return;
      }

      try {
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password
        });

        if (error) {
          showMessage('signup-message', error.message, true);
        } else {
          showMessage('signup-message', 'Account created successfully!');
          // Clear form
          document.getElementById('signup-email').value = '';
          document.getElementById('signup-password').value = '';
        }
      } catch (err) {
        showMessage('signup-message', 'An error occurred during signup', true);
      }
    }

    // Sign in function
    async function signIn() {
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;

      hideMessage('signin-message');

      if (!email || !password) {
        showMessage('signin-message', 'Please fill in all fields', true);
        return;
      }

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          showMessage('signin-message', error.message, true);
        } else {
          showMessage('signin-message', 'Signed in successfully!');
          // Clear form
          document.getElementById('signin-password').value = '';
        }
      } catch (err) {
        showMessage('signin-message', 'An error occurred during signin', true);
      }
    }

    // Sign out function
    async function signOut() {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) {
          console.error('Sign out error:', error);
        }
      } catch (err) {
        console.error('Sign out failed:', err);
      }
    }

    // Reset password function
    async function resetPassword() {
      const email = document.getElementById('reset-email').value;

      hideMessage('reset-message');

      if (!email) {
        showMessage('reset-message', 'Please enter your email address', true);
        return;
      }

      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://charles85298.github.io/budget-tracker/?page=change-password'
        });

        if (error) {
          showMessage('reset-message', error.message, true);
        } else {
          showMessage('reset-message', 'Password reset email sent! Check your inbox and click the link to set a new password.');
          document.getElementById('reset-email').value = '';
        }
      } catch (err) {
        showMessage('reset-message', 'An error occurred while sending reset email', true);
      }
    }

    // Toggle between sign in and password reset forms
    function togglePasswordReset() {
      const signinSection = document.getElementById('signin-section');
      const resetSection = document.getElementById('reset-section');

      if (resetSection.classList.contains('hide')) {
        // Show reset form, hide sign in
        signinSection.classList.add('hide');
        resetSection.classList.remove('hide');
        hideMessage('signin-message');
      } else {
        // Show sign in form, hide reset
        resetSection.classList.add('hide');
        signinSection.classList.remove('hide');
        hideMessage('reset-message');
      }
    }

    // Update password after recovery
    async function updatePassword() {
      const newPassword = document.getElementById('new-password').value;

      hideMessage('new-password-message');

      if (!newPassword) {
        showMessage('new-password-message', 'Please enter a new password', true);
        return;
      }

      if (newPassword.length < 6) {
        showMessage('new-password-message', 'Password must be at least 6 characters', true);
        return;
      }

      try {
        const { data, error } = await supabase.auth.updateUser({ 
          password: newPassword 
        });

        if (error) {
          // Check if AAL2 (MFA) is required
          if (error.message?.includes('AAL2') || error.message?.includes('MFA')) {
            showMessage('new-password-message', 'MFA verification required to change password');
            await initiatePasswordMFAChallenge(newPassword);
          } else {
            showMessage('new-password-message', error.message, true);
          }
        } else {
          showMessage('new-password-message', 'Password updated successfully! Redirecting to login...');
          document.getElementById('new-password').value = '';
          
          // Redirect back to main login page after successful password change
          setTimeout(() => {
            window.location.href = window.location.origin + window.location.pathname;
          }, 2000);
        }
      } catch (err) {
        showMessage('new-password-message', 'An error occurred while updating password', true);
      }
    }

    // Initiate MFA challenge for password change
    async function initiatePasswordMFAChallenge(password) {
      try {
        // Store password for after MFA verification
        pendingPassword = password;
        
        // Get user's MFA factors
        const { data: factors, error: factorsError } = await supabase.auth.mfa.listFactors();
        if (factorsError || !factors?.totp?.length) {
          showMessage('new-password-message', 'No MFA factors found', true);
          return;
        }

        // Use first verified TOTP factor
        const totpFactor = factors.totp.find(f => f.status === 'verified');
        if (!totpFactor) {
          showMessage('new-password-message', 'No verified TOTP factor found', true);
          return;
        }

        currentFactorId = totpFactor.id;

        // Create MFA challenge
        const { data: challenge, error: challengeError } = await supabase.auth.mfa.challenge({
          factorId: currentFactorId
        });

        if (challengeError) {
          showMessage('new-password-message', 'Failed to create MFA challenge: ' + challengeError.message, true);
          return;
        }

        currentChallengeId = challenge.id;
        
        // Show MFA challenge form
        document.getElementById('new-password-section').classList.add('hide');
        document.getElementById('mfa-challenge-section').classList.remove('hide');
        
      } catch (error) {
        showMessage('new-password-message', 'Error setting up MFA challenge', true);
      }
    }

    // Verify MFA and update password
    async function verifyMFAAndUpdatePassword() {
      const code = document.getElementById('mfa-challenge-code').value;
      
      hideMessage('mfa-challenge-message');

      if (!code || code.length !== 6) {
        showMessage('mfa-challenge-message', 'Please enter a 6-digit code', true);
        return;
      }

      if (!currentChallengeId || !currentFactorId || !pendingPassword) {
        showMessage('mfa-challenge-message', 'Invalid challenge state', true);
        return;
      }

      try {
        // Verify MFA code
        const { data, error: verifyError } = await supabase.auth.mfa.verify({
          factorId: currentFactorId,
          challengeId: currentChallengeId,
          code: code
        });

        if (verifyError) {
          showMessage('mfa-challenge-message', 'Invalid code: ' + verifyError.message, true);
          return;
        }

        showMessage('mfa-challenge-message', 'MFA verified! Updating password...');

        // Now try password update again (should work with AAL2)
        const { data: updateData, error: updateError } = await supabase.auth.updateUser({ 
          password: pendingPassword 
        });

        if (updateError) {
          showMessage('mfa-challenge-message', 'Password update failed: ' + updateError.message, true);
        } else {
          showMessage('mfa-challenge-message', 'Password updated successfully! Redirecting to login...');
          
          // Clear stored values
          currentChallengeId = null;
          currentFactorId = null;
          pendingPassword = null;
          document.getElementById('mfa-challenge-code').value = '';
          
          // Redirect back to main login page
          setTimeout(() => {
            window.location.href = window.location.origin + window.location.pathname;
          }, 2000);
        }

      } catch (error) {
        showMessage('mfa-challenge-message', 'Error verifying MFA code', true);
      }
    }

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event, session?.user?.email || 'no user');
      
      if (event === 'PASSWORD_RECOVERY') {
        // Force user to set new password instead of just logging in
        console.log('Password recovery detected - forcing password change');
        updateStatus(session?.user || null, true); // true = isPasswordRecovery
      } else {
        updateStatus(session?.user || null, false);
      }
    });

    // Check initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      updateStatus(session?.user || null);
    });
  </script>
</body>
</html>
