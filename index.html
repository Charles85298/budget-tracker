<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget Tracker – Google Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 2rem auto; padding: 0 1rem; }
    button { padding: 6px 12px; margin: 6px 0; }
    pre { background:#f6f6f6; padding:10px; border-radius:8px; overflow:auto; }
    #status.ok { color:#0a7; } #status.err { color:#c00; }
  </style>
</head>
<body>
  <h1>Budget Tracker – Login</h1>

  <div>
    <button id="google">Continue with Google</button>
    <button id="signout" disabled>Sign out</button>
  </div>

  <p id="status" class="err">Not signed in.</p>

  <h3>Debug</h3>
  <pre id="log"></pre>

  <h3>Read test</h3>
  <button id="read" disabled>Read employers</button>
  <pre id="out"></pre>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const outEl = document.getElementById('out');
    const readBtn = document.getElementById('read');
    const googleBtn = document.getElementById('google');
    const signoutBtn = document.getElementById('signout');

    const log = (label, val) => {
      const msg = `${label}: ${typeof val === 'string' ? val : JSON.stringify(val, null, 2)}`;
      logEl.textContent += msg + "\n\n";
      console.log(label, val);
    };
    const setSignedIn = (email) => {
      statusEl.textContent = `Signed in as: ${email}`;
      statusEl.classList.remove('err'); statusEl.classList.add('ok');
      readBtn.disabled = false; signoutBtn.disabled = false;
    };
    const setSignedOut = () => {
      statusEl.textContent = 'Not signed in.';
      statusEl.classList.remove('ok'); statusEl.classList.add('err');
      readBtn.disabled = true; signoutBtn.disabled = true;
    };

    // A) Handle redirect tokens (OAuth PKCE)
    async function handleRedirect() {
      const href = location.href;
      log('URL on load', href);
      if (href.includes('code=') || href.includes('access_token=')) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(href);
        if (error) log('exchangeCodeForSession error', error.message);
        else log('exchangeCodeForSession data', data);
        history.replaceState({}, document.title, '/budget-tracker/');
      }
    }
    await handleRedirect();

    // B) Refresh session UI
    async function refreshSession() {
      const { data: { session }, error } = await supabase.auth.getSession();
      log('getSession error', error ?? 'none');
      log('getSession session', session ?? null);
      if (session?.user?.email) setSignedIn(session.user.email);
      else setSignedOut();
    }
    await refreshSession();

    // C) Listen for auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      log('onAuthStateChange', { event, user: session?.user ?? null });
      if (session?.user?.email) setSignedIn(session.user.email);
      else setSignedOut();
    });

    // D) Google OAuth
    googleBtn.addEventListener('click', async
