<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget Tracker – Email/Password Auth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; max-width: 780px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: 0.25rem; }
    .muted { color: #666; margin-top: 0; }
    form { display: grid; gap: 8px; margin: 12px 0 20px; max-width: 440px; }
    label { font-weight: 600; }
    input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 10px; align-items: center; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px; margin: 10px 0; }
    pre { background:#f6f6f6; padding:10px; border-radius:8px; overflow:auto; }
    #status.ok { color:#0a7; } #status.err { color:#c00; }
    .hide { display: none; }
  </style>
</head>
<body>
  <h1>Budget Tracker</h1>
  <p class="muted">Email + password sign in (Supabase Auth)</p>

  <!-- Status -->
  <p id="status" class="err">Not signed in.</p>
  <div class="row">
    <button id="signout" class="hide">Sign out</button>
  </div>

  <!-- Auth forms -->
  <div class="card" id="signup-card">
    <h3>Create account</h3>
    <form id="signup-form">
      <div>
        <label for="su-email">Email</label>
        <input id="su-email" type="email" placeholder="you@example.com" required />
      </div>
      <div>
        <label for="su-password">Password</label>
        <input id="su-password" type="password" placeholder="At least 6 characters" minlength="6" required />
      </div>
      <button type="submit" id="signup-btn">Sign up</button>
      <div id="signup-msg"></div>
    </form>
  </div>

  <div class="card" id="signin-card">
    <h3>Sign in</h3>
    <form id="signin-form">
      <div>
        <label for="si-email">Email</label>
        <input id="si-email" type="email" placeholder="you@example.com" required />
      </div>
      <div>
        <label for="si-password">Password</label>
        <input id="si-password" type="password" placeholder="Your password" required />
      </div>
      <button type="submit" id="signin-btn">Sign in</button>
      <div id="signin-msg"></div>
    </form>
    <button id="forgot-btn">Forgot password?</button>
  </div>

  <div class="card hide" id="forgot-card">
    <h3>Reset password</h3>
    <form id="forgot-form">
      <div>
        <label for="fp-email">Email</label>
        <input id="fp-email" type="email" placeholder="you@example.com" required />
      </div>
      <button type="submit" id="forgot-send">Send reset email</button>
      <div id="forgot-msg"></div>
    </form>
  </div>

  <div class="card hide" id="recovery-card">
    <h3>Set a new password</h3>
    <form id="recovery-form">
      <div>
        <label for="rp-password">New password</label>
        <input id="rp-password" type="password" placeholder="New password" minlength="6" required />
      </div>
      <button type="submit" id="recovery-save">Save new password</button>
      <div id="recovery-msg"></div>
    </form>
  </div>

  <!-- Read test -->
  <div class="card">
    <h3>Read test (paychecks → employer)</h3>
    <button id="read" disabled>Read employers</button>
    <pre id="out"></pre>
  </div>

  <!-- Debug -->
  <div class="card">
    <h3>Debug</h3>
    <pre id="log"></pre>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // Elements
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const outEl = document.getElementById('out');
    const readBtn = document.getElementById('read');
    const signoutBtn = document.getElementById('signout');

    const signupCard = document.getElementById('signup-card');
    const signinCard = document.getElementById('signin-card');
    const forgotCard = document.getElementById('forgot-card');
    const recoveryCard = document.getElementById('recovery-card');

    const signupForm = document.getElementById('signup-form');
    const signinForm = document.getElementById('signin-form');
    const forgotForm = document.getElementById('forgot-form');
    const recoveryForm = document.getElementById('recovery-form');

    const signupMsg = document.getElementById('signup-msg');
    const signinMsg = document.getElementById('signin-msg');
    const forgotMsg = document.getElementById('forgot-msg');
    const recoveryMsg = document.getElementById('recovery-msg');

    const forgotBtn = document.getElementById('forgot-btn');

    // Helpers
    const log = (label, val) => {
      const msg = `${label}: ${typeof val === 'string' ? val : JSON.stringify(val, null, 2)}`;
      logEl.textContent += msg + "\\n\\n";
      console.log(label, val);
    };
    const setSignedIn = (email) => {
      statusEl.textContent = `Signed in as: ${email}`;
      statusEl.classList.remove('err'); statusEl.classList.add('ok');
      signoutBtn.classList.remove('hide');
      readBtn.disabled = false;
      signupCard.classList.add('hide');
      signinCard.classList.add('hide');
      forgotCard.classList.add('hide');
    };
    const setSignedOut = () => {
      statusEl.textContent = 'Not signed in.';
      statusEl.classList.remove('ok'); statusEl.classList.add('err');
      signoutBtn.classList.add('hide');
      readBtn.disabled = true;
      signupCard.classList.remove('hide');
      signinCard.classList.remove('hide');
      // recoveryCard stays hidden unless in recovery mode
      recoveryCard.classList.add('hide');
    };

    // A) Handle redirects (email confirmation or password recovery)
    async function handleRedirect() {
      const href = location.href;
      log('URL on load', href);
      const hasTokens = href.includes('code=') || href.includes('access_token=');
      if (hasTokens) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(href);
        if (error) log('exchangeCodeForSession error', error.message);
        else {
          log('exchangeCodeForSession data', data);
        }
        // Clean URL
        history.replaceState({}, document.title, '/budget-tracker/');
      }

      // If this is a password recovery session (user clicked "reset password" email),
      // Supabase will set the session type to 'recovery'. Show new password form.
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user && session?.expires_at) {
        // try to detect recovery via event hook as well
      }
    }

    await handleRedirect();

    // B) Reflect session
    async function refreshSession() {
      const { data: { session }, error } = await supabase.auth.getSession();
      log('getSession error', error ?? 'none');
      log('getSession session', session ?? null);
      if (session?.user?.email) {
        setSignedIn(session.user.email);
      } else {
        setSignedOut();
      }
    }
    await refreshSession();

    // C) Auth state changes (also detects recovery)
    supabase.auth.onAuthStateChange((event, session) => {
      log('onAuthStateChange', { event, user: session?.user ?? null });
      if (session?.user?.email) {
        setSignedIn(session.user.email);
        if (event === 'PASSWORD_RECOVERY' || event === 'USER_UPDATED') {
          // Show recovery form when landing from reset email
          signinCard.classList.add('hide');
          signupCard.classList.add('hide');
          forgotCard.classList.add('hide');
          recoveryCard.classList.remove('hide');
        }
      } else {
        setSignedOut();
      }
    });

    // D) Sign up
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupMsg.textContent = '...';
      const email = document.getElementById('su-email').value.trim();
      const password = document.getElementById('su-password').value;

      const { data, error } = await supabase.auth.signUp({
        email, password,
        options: {
          // If email confirmations are ON, user must click the email and return to this page.
          emailRedirectTo: 'https://charles85298.github.io/budget-tracker/'
        }
      });
      if (error) {
        signupMsg.textContent = 'Error: ' + error.message;
      } else {
        // If confirmations OFF → you may already be signed in. If ON → they must verify email.
        signupMsg.textContent = data?.user?.email_confirmed_at
          ? 'Account created & confirmed.'
          : 'Check your email to confirm your account.';
        log('signUp', data);
        await refreshSession();
      }
    });

    // E) Sign in (email + password)
    signinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signinMsg.textContent = '...';
      const email = document.getElementById('si-email').value.trim();
      const password = document.getElementById('si-password').value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        signinMsg.textContent = 'Error: ' + error.message;
      } else {
        signinMsg.textContent = 'Signed in.';
        log('signInWithPassword', data);
        await refreshSession();
      }
    });

    // F) Forgot password → send reset email
    forgotBtn.addEventListener('click', () => {
      forgotCard.classList.toggle('hide');
    });
    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      forgotMsg.textContent = '...';
      const email = document.getElementById('fp-email').value.trim();
      const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: 'https://charles85298.github.io/budget-tracker/'
      });
      if (error) forgotMsg.textContent = 'Error: ' + error.message;
      else {
        forgotMsg.textContent = 'Reset email sent. Check your inbox.';
        log('resetPasswordForEmail', data);
      }
    });

    // G) Recovery: set new password
    recoveryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      recoveryMsg.textContent = '...';
      const newPassword = document.getElementById('rp-password').value;
      const { data, error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) recoveryMsg.textContent = 'Error: ' + error.message;
      else {
        recoveryMsg.textContent = 'Password updated. You are signed in.';
        log('updateUser (password)', data);
        await refreshSession();
      }
    });

    // H) Sign out
    signoutBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) log('signOut error', error.message);
      setSignedOut();
    });

    // I) Read test (requires your RLS policy to allow authenticated users)
    readBtn.addEventListener('click', async () => {
      outEl.textContent = 'Loading…';
      const { data, error } = await supabase
        .from('paychecks')
        .select('paycheck_id, employer, pay_date, net_amount')
        .limit(10);
      outEl.textContent = error ? `Error: ${error.message}` : JSON.stringify(data, null, 2);
      log('read paychecks', error ?? data);
    });
  </script>
</body>
</html>
