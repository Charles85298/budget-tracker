<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Login Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      font-family: system-ui, Arial; 
      max-width: 600px; 
      margin: 2rem auto; 
      padding: 1rem; 
    }
    .status {
      font-size: 1.2em;
      font-weight: bold;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    .logged-in { 
      background: #d4edda; 
      color: #155724; 
      border: 1px solid #c3e6cb;
    }
    .logged-out { 
      background: #f8d7da; 
      color: #721c24; 
      border: 1px solid #f5c6cb;
    }
    .card { 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      padding: 1rem; 
      margin: 1rem 0; 
    }
    .form-group { 
      margin: 0.5rem 0; 
    }
    label { 
      display: block; 
      margin-bottom: 0.25rem; 
    }
    input { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
    }
    button { 
      background: #007bff; 
      color: white; 
      border: none; 
      padding: 0.75rem 1rem; 
      border-radius: 4px; 
      cursor: pointer; 
      margin: 0.5rem 0; 
    }
    button:hover { 
      background: #0056b3; 
    }
    .hide { 
      display: none; 
    }
    .message { 
      padding: 0.5rem; 
      margin: 0.5rem 0; 
      border-radius: 4px; 
    }
    .success { 
      background: #d4edda; 
      color: #155724; 
    }
    .error { 
      background: #f8d7da; 
      color: #721c24; 
    }
  </style>
</head>
<body>
  <h1>Simple Login Test</h1>

  <!-- Login Status Display -->
  <div id="status" class="status logged-out">
    Not signed in
  </div>

  <!-- Sign Up Form -->
  <div class="card" id="signup-section">
    <h2>Create Account</h2>
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="signup-email" placeholder="you@example.com" />
    </div>
    <div class="form-group">
      <label>Password:</label>
      <input type="password" id="signup-password" placeholder="Password" />
    </div>
    <button onclick="signUp()">Sign Up</button>
    <div id="signup-message" class="message hide"></div>
  </div>

  <!-- Sign In Form -->
  <div class="card" id="signin-section">
    <h2>Sign In</h2>
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="signin-email" placeholder="you@example.com" />
    </div>
    <div class="form-group">
      <label>Password:</label>
      <input type="password" id="signin-password" placeholder="Password" />
    </div>
    <button onclick="signIn()">Sign In</button>
    <button onclick="togglePasswordReset()" style="background: #6c757d;">Forgot Password?</button>
    <div id="signin-message" class="message hide"></div>
  </div>

  <!-- Password Reset Form (hidden by default) -->
  <div class="card hide" id="reset-section">
    <h2>Reset Password</h2>
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="reset-email" placeholder="you@example.com" />
    </div>
    <button onclick="resetPassword()">Send Reset Email</button>
    <button onclick="togglePasswordReset()" style="background: #6c757d;">Back to Sign In</button>
    <div id="reset-message" class="message hide"></div>
  </div>

  <!-- Sign Out Button (hidden when logged out) -->
  <div class="card hide" id="signout-section">
    <button onclick="signOut()">Sign Out</button>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // Make functions available globally
    window.supabase = supabase;
    window.signUp = signUp;
    window.signIn = signIn;
    window.signOut = signOut;
    window.resetPassword = resetPassword;
    window.togglePasswordReset = togglePasswordReset;

    // Update UI based on login status
    function updateStatus(user) {
      const statusEl = document.getElementById('status');
      const signupSection = document.getElementById('signup-section');
      const signinSection = document.getElementById('signin-section');
      const signoutSection = document.getElementById('signout-section');

      if (user) {
        statusEl.textContent = `Logged in as: ${user.email}`;
        statusEl.className = 'status logged-in';
        signupSection.classList.add('hide');
        signinSection.classList.add('hide');
        signoutSection.classList.remove('hide');
      } else {
        statusEl.textContent = 'Not signed in';
        statusEl.className = 'status logged-out';
        signupSection.classList.remove('hide');
        signinSection.classList.remove('hide');
        signoutSection.classList.add('hide');
      }
    }

    // Show message
    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message ${isError ? 'error' : 'success'}`;
      el.classList.remove('hide');
    }

    // Hide message
    function hideMessage(elementId) {
      document.getElementById(elementId).classList.add('hide');
    }

    // Sign up function
    async function signUp() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      hideMessage('signup-message');

      if (!email || !password) {
        showMessage('signup-message', 'Please fill in all fields', true);
        return;
      }

      try {
        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password
        });

        if (error) {
          showMessage('signup-message', error.message, true);
        } else {
          showMessage('signup-message', 'Account created successfully!');
          // Clear form
          document.getElementById('signup-email').value = '';
          document.getElementById('signup-password').value = '';
        }
      } catch (err) {
        showMessage('signup-message', 'An error occurred during signup', true);
      }
    }

    // Sign in function
    async function signIn() {
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;

      hideMessage('signin-message');

      if (!email || !password) {
        showMessage('signin-message', 'Please fill in all fields', true);
        return;
      }

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          showMessage('signin-message', error.message, true);
        } else {
          showMessage('signin-message', 'Signed in successfully!');
          // Clear form
          document.getElementById('signin-password').value = '';
        }
      } catch (err) {
        showMessage('signin-message', 'An error occurred during signin', true);
      }
    }

    // Sign out function
    async function signOut() {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) {
          console.error('Sign out error:', error);
        }
      } catch (err) {
        console.error('Sign out failed:', err);
      }
    }

    // Reset password function
    async function resetPassword() {
      const email = document.getElementById('reset-email').value;

      hideMessage('reset-message');

      if (!email) {
        showMessage('reset-message', 'Please enter your email address', true);
        return;
      }

      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + window.location.pathname
        });

        if (error) {
          showMessage('reset-message', error.message, true);
        } else {
          showMessage('reset-message', 'Password reset email sent! Check your inbox.');
          document.getElementById('reset-email').value = '';
        }
      } catch (err) {
        showMessage('reset-message', 'An error occurred while sending reset email', true);
      }
    }

    // Toggle between sign in and password reset forms
    function togglePasswordReset() {
      const signinSection = document.getElementById('signin-section');
      const resetSection = document.getElementById('reset-section');

      if (resetSection.classList.contains('hide')) {
        // Show reset form, hide sign in
        signinSection.classList.add('hide');
        resetSection.classList.remove('hide');
        hideMessage('signin-message');
      } else {
        // Show sign in form, hide reset
        resetSection.classList.add('hide');
        signinSection.classList.remove('hide');
        hideMessage('reset-message');
      }
    }

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event, session?.user?.email || 'no user');
      updateStatus(session?.user || null);
    });

    // Check initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      updateStatus(session?.user || null);
    });
  </script>
</body>
</html>
