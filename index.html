<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Budget Tracker</title>
    
    <!-- SECURITY: Content Security Policy - Blocks unauthorized scripts/resources -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.skypack.dev https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self' https://*.supabase.co https://cdn.skypack.dev;
        base-uri 'self';
        form-action 'self';
        object-src 'none';
    ">
    
    <!-- SECURITY: Prevent MIME type sniffing -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <!-- SECURITY: XSS Protection -->
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- SECURITY: Frame Options -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 300px; padding: 8px; }
        .error-message { color: red; margin: 10px 0; display: none; }
        .success-message { color: green; margin: 10px 0; display: none; }
        .rate-limit-notice { color: orange; margin: 10px 0; display: none; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .mfa-container, .qr-container { margin: 20px 0; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Secure Budget Tracker</h1>
    
    <!-- Login Form with Security Enhancements -->
    <div id="loginSection">
        <h2>Login</h2>
        <form id="loginForm" autocomplete="on">
            <div class="form-group">
                <label for="email">Email:</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email"
                    autocomplete="email"
                    required
                    placeholder="Enter your email"
                >
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password"
                    autocomplete="current-password"
                    required
                    placeholder="Enter your password"
                    minlength="8"
                >
            </div>
            
            <button type="submit" id="loginButton">Login</button>
        </form>
        
        <div id="rateLimitNotice" class="rate-limit-notice">
            Too many login attempts. Please wait before trying again.
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <p><button type="button" id="showRegisterBtn">Register New Account</button></p>
    </div>

    <!-- Registration Form -->
    <div id="registerSection" style="display: none;">
        <h2>Register</h2>
        <form id="registerForm" autocomplete="on">
            <div class="form-group">
                <label for="regEmail">Email:</label>
                <input 
                    type="email" 
                    id="regEmail" 
                    name="email"
                    autocomplete="email"
                    required
                    placeholder="Enter your email"
                >
            </div>
            
            <div class="form-group">
                <label for="regPassword">Password (minimum 12 characters):</label>
                <input 
                    type="password" 
                    id="regPassword" 
                    name="new-password"
                    autocomplete="new-password"
                    required
                    placeholder="Create a strong password"
                    minlength="12"
                >
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirm-password"
                    autocomplete="new-password"
                    required
                    placeholder="Confirm your password"
                    minlength="12"
                >
            </div>
            
            <!-- CAPTCHA placeholder - implement with your preferred service -->
            <div class="form-group">
                <div id="captchaContainer">
                    <!-- Replace with actual CAPTCHA implementation -->
                    <div style="border: 1px dashed #ccc; padding: 20px; text-align: center; background: #f9f9f9;">
                        CAPTCHA Integration Point
                        <br><small>Implement Turnstile, hCaptcha, or similar</small>
                    </div>
                </div>
            </div>
            
            <button type="submit" id="registerButton">Register</button>
        </form>
        
        <p><button type="button" id="showLoginBtn">Back to Login</button></p>
    </div>

    <!-- QR Code Display Container (secure) -->
    <div id="qrContainer" class="qr-container" style="display: none;">
        <h3>MFA Setup QR Code</h3>
        <div id="qrCodeDisplay"></div>
    </div>

    <!-- MFA Factors Table Container (secure) -->
    <div id="mfaFactorsContainer" class="mfa-container" style="display: none;">
        <h3>Multi-Factor Authentication</h3>
        <table id="mfaFactorsTable">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="mfaFactorsBody">
                <!-- Populated securely via JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Dashboard (shown after login) -->
    <div id="dashboardSection" style="display: none;">
        <h2>Dashboard</h2>
        <div id="householdInfo"></div>
        <div id="accountsList"></div>
        <button type="button" id="logoutButton">Logout</button>
    </div>

    <script type="module">
        // Import your existing Supabase client
        import { supabase } from './supabaseClient.js';

        // SECURITY: Rate limiting class
        class RateLimiter {
            constructor(maxAttempts = 5, windowMs = 15 * 60 * 1000) {
                this.attempts = new Map();
                this.maxAttempts = maxAttempts;
                this.windowMs = windowMs;
            }
            
            isAllowed(identifier) {
                const now = Date.now();
                const userAttempts = this.attempts.get(identifier) || [];
                const recentAttempts = userAttempts.filter(time => now - time < this.windowMs);
                
                if (recentAttempts.length >= this.maxAttempts) {
                    return false;
                }
                
                this.attempts.set(identifier, [...recentAttempts, now]);
                return true;
            }
            
            getRemainingTime(identifier) {
                const userAttempts = this.attempts.get(identifier) || [];
                if (userAttempts.length === 0) return 0;
                
                const oldestAttempt = Math.min(...userAttempts);
                const timeRemaining = this.windowMs - (Date.now() - oldestAttempt);
                return Math.max(0, timeRemaining);
            }
        }

        // Initialize rate limiter
        const loginLimiter = new RateLimiter(5, 15 * 60 * 1000);

        // SECURITY: Safe DOM manipulation utilities
        const SafeDOM = {
            // Safe alternative to innerHTML
            setTextContent(element, text) {
                if (element) {
                    element.textContent = text || '';
                }
            },
            
            // Safe way to create elements with text
            createElement(tag, textContent = '', attributes = {}) {
                const element = document.createElement(tag);
                if (textContent) {
                    element.textContent = textContent;
                }
                Object.entries(attributes).forEach(([key, value]) => {
                    element.setAttribute(key, String(value));
                });
                return element;
            },
            
            // Safe way to clear and populate container
            replaceContent(container, ...elements) {
                if (container) {
                    container.replaceChildren(...elements);
                }
            },

            // Safe way to show/hide elements
            show(element) {
                if (element) element.style.display = 'block';
            },

            hide(element) {
                if (element) element.style.display = 'none';
            }
        };

        // SECURITY: Safe error display
        function displayError(message) {
            const errorContainer = document.getElementById('errorMessage');
            // SECURITY: Never display raw error messages that might contain sensitive data
            let safeMessage = 'An error occurred. Please try again.';
            
            if (typeof message === 'string') {
                if (message.includes('duplicate key') || message.includes('already registered')) {
                    safeMessage = 'This email is already registered.';
                } else if (message.includes('invalid_grant') || message.includes('Invalid login')) {
                    safeMessage = 'Invalid email or password.';
                } else if (message.includes('Email not confirmed')) {
                    safeMessage = 'Please check your email and confirm your account.';
                } else if (message.includes('too many requests') || message.includes('rate limit')) {
                    safeMessage = 'Too many attempts. Please wait before trying again.';
                }
            }
            
            SafeDOM.setTextContent(errorContainer, safeMessage);
            SafeDOM.show(errorContainer);
            
            // Auto-hide error after 5 seconds
            setTimeout(() => {
                SafeDOM.hide(errorContainer);
            }, 5000);
        }

        function displaySuccess(message) {
            const successContainer = document.getElementById('successMessage');
            SafeDOM.setTextContent(successContainer, message);
            SafeDOM.show(successContainer);
            
            setTimeout(() => {
                SafeDOM.hide(successContainer);
            }, 5000);
        }

        // SECURITY: Safe QR code display
        function displayQRCode(qrCodeDataUrl) {
            const qrContainer = document.getElementById('qrContainer');
            const qrDisplay = document.getElementById('qrCodeDisplay');
            
            // SECURITY: Use createElement instead of innerHTML
            const img = SafeDOM.createElement('img', '', {
                'src': qrCodeDataUrl,
                'alt': 'QR Code for MFA setup',
                'style': 'max-width: 200px; height: auto; border: 1px solid #ddd;'
            });
            
            SafeDOM.replaceContent(qrDisplay, img);
            SafeDOM.show(qrContainer);
        }

        // SECURITY: Safe MFA factors table population
        function displayMFAFactors(factors) {
            const tableBody = document.getElementById('mfaFactorsBody');
            const container = document.getElementById('mfaFactorsContainer');
            
            // Clear existing content safely
            SafeDOM.replaceContent(tableBody);
            
            if (!factors || factors.length === 0) {
                const row = SafeDOM.createElement('tr');
                const cell = SafeDOM.createElement('td', 'No MFA factors configured', { 'colspan': '4' });
                row.appendChild(cell);
                tableBody.appendChild(row);
            } else {
                factors.forEach(factor => {
                    const row = document.createElement('tr');
                    
                    // SECURITY: Use textContent for all user data
                    const typeCell = SafeDOM.createElement('td', factor.type || 'Unknown');
                    const statusCell = SafeDOM.createElement('td', factor.status || 'Unknown');
                    const createdCell = SafeDOM.createElement('td', 
                        factor.created_at ? new Date(factor.created_at).toLocaleDateString() : 'Unknown'
                    );
                    
                    const actionsCell = document.createElement('td');
                    const deleteButton = SafeDOM.createElement('button', 'Delete', {
                        'type': 'button',
                        'data-factor-id': factor.id,
                        'style': 'background: #dc3545; font-size: 12px; padding: 4px 8px;'
                    });
                    
                    deleteButton.addEventListener('click', (e) => {
                        const factorId = e.target.getAttribute('data-factor-id');
                        deleteMFAFactor(factorId);
                    });
                    
                    actionsCell.appendChild(deleteButton);
                    
                    row.appendChild(typeCell);
                    row.appendChild(statusCell);
                    row.appendChild(createdCell);
                    row.appendChild(actionsCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            SafeDOM.show(container);
        }

        // Login form handler with rate limiting
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // SECURITY: Input validation
            if (!email || !password) {
                displayError('Please enter both email and password.');
                return;
            }
            
            // SECURITY: Rate limiting check
            if (!loginLimiter.isAllowed(email)) {
                const remainingTime = Math.ceil(loginLimiter.getRemainingTime(email) / 1000 / 60);
                displayError(`Too many login attempts. Please wait ${remainingTime} minutes.`);
                SafeDOM.show(document.getElementById('rateLimitNotice'));
                return;
            }
            
            const loginButton = document.getElementById('loginButton');
            loginButton.disabled = true;
            SafeDOM.setTextContent(loginButton, 'Logging in...');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    displayError(error.message);
                    return;
                }
                
                // Successful login
                displaySuccess('Login successful!');
                showDashboard(data.user);
                
            } catch (error) {
                displayError('Network error. Please check your connection.');
            } finally {
                loginButton.disabled = false;
                SafeDOM.setTextContent(loginButton, 'Login');
                SafeDOM.hide(document.getElementById('rateLimitNotice'));
            }
        });

        // Registration form handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // SECURITY: Input validation
            if (!email || !password || !confirmPassword) {
                displayError('Please fill in all fields.');
                return;
            }
            
            // Validate password match
            if (password !== confirmPassword) {
                displayError('Passwords do not match.');
                return;
            }
            
            // Validate password strength
            if (password.length < 12) {
                displayError('Password must be at least 12 characters long.');
                return;
            }
            
            const registerButton = document.getElementById('registerButton');
            registerButton.disabled = true;
            SafeDOM.setTextContent(registerButton, 'Registering...');
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: `${window.location.origin}/confirm`
                    }
                });
                
                if (error) {
                    displayError(error.message);
                    return;
                }
                
                displaySuccess('Registration successful! Please check your email for confirmation.');
                
            } catch (error) {
                displayError('Network error. Please check your connection.');
            } finally {
                registerButton.disabled = false;
                SafeDOM.setTextContent(registerButton, 'Register');
            }
        });

        // Navigation between login and register
        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            SafeDOM.hide(document.getElementById('loginSection'));
            SafeDOM.show(document.getElementById('registerSection'));
        });

        document.getElementById('showLoginBtn').addEventListener('click', () => {
            SafeDOM.hide(document.getElementById('registerSection'));
            SafeDOM.show(document.getElementById('loginSection'));
        });

        // Dashboard functions
        async function showDashboard(user) {
            SafeDOM.hide(document.getElementById('loginSection'));
            SafeDOM.hide(document.getElementById('registerSection'));
            SafeDOM.show(document.getElementById('dashboardSection'));
            
            // Load household info
            await loadHouseholdInfo();
            await loadAccounts();
        }

        async function loadHouseholdInfo() {
            try {
                const { data, error } = await supabase.rpc('get_user_household_id');
                
                if (!error && data) {
                    const householdInfo = document.getElementById('householdInfo');
                    const infoElement = SafeDOM.createElement('p', `Household ID: ${data}`);
                    SafeDOM.replaceContent(householdInfo, infoElement);
                }
            } catch (error) {
                console.error('Error loading household info:', error);
            }
        }

        async function loadAccounts() {
            try {
                const { data, error } = await supabase
                    .from('accounts')
                    .select('account_id, account_name, account_type')
                    .order('account_name');
                
                if (!error && data) {
                    const accountsList = document.getElementById('accountsList');
                    const title = SafeDOM.createElement('h3', 'Your Accounts');
                    const list = document.createElement('ul');
                    
                    data.forEach(account => {
                        const item = SafeDOM.createElement('li', 
                            `${account.account_name} (${account.account_type})`
                        );
                        list.appendChild(item);
                    });
                    
                    SafeDOM.replaceContent(accountsList, title, list);
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        // MFA factor deletion (secure)
        async function deleteMFAFactor(factorId) {
            if (!confirm('Are you sure you want to delete this MFA factor?')) {
                return;
            }
            
            try {
                const { error } = await supabase.auth.mfa.deleteFactor({ id: factorId });
                
                if (error) {
                    displayError('Failed to delete MFA factor.');
                    return;
                }
                
                // Refresh MFA factors list
                loadMFAFactors();
                
            } catch (error) {
                displayError('Network error. Please try again.');
            }
        }

        // Load MFA factors (secure)
        async function loadMFAFactors() {
            try {
                const { data, error } = await supabase.auth.mfa.listFactors();
                
                if (error) {
                    displayError('Failed to load MFA factors.');
                    return;
                }
                
                displayMFAFactors(data.factors || []);
                
            } catch (error) {
                displayError('Network error. Please try again.');
            }
        }

        // Logout handler
        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                await supabase.auth.signOut();
                SafeDOM.hide(document.getElementById('dashboardSection'));
                SafeDOM.show(document.getElementById('loginSection'));
                
                // Clear form data
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                
            } catch (error) {
                displayError('Error during logout.');
            }
        });

        // SECURITY: Clear sensitive form data on page unload
        window.addEventListener('beforeunload', () => {
            document.getElementById('password').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });

        // Check initial auth state
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                showDashboard(session.user);
            } else {
                SafeDOM.show(document.getElementById('loginSection'));
                SafeDOM.hide(document.getElementById('dashboardSection'));
            }
        });
    </script>
</body>
</html>
